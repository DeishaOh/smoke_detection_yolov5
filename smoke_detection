'''
- roboflowì—ì„œ ë°ì´í„°ë¥¼ ë‹¤ìš´ë°›ì•„ ëª¨ë¸ ê·¸ëŒ€ë¡œ ëŒë¦¬ê¸°ë§Œ í•˜ë©´ ì—¬ëŸ¬ detection ëª¨ë¸ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤
- ì½”ë©ì—ì„œ 12gë°–ì— ëª»ì¨ì„œ epochì„ 100ê¹Œì§€ë°–ì— ì£¼ì§€ ëª»í–ˆë‹¤. gpu ì„±ëŠ¥ë§Œ ë”°ë¼ì˜¤ë©´ í›¨ì”¬ ë” ë†’ì€ ì„±ëŠ¥ì˜ ëª¨ë¸ ìƒì„± ê°€ëŠ¥
- roboflowì—ì„  ê°ì²´ê°€ 2ê°œì¸ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í–ˆë‹¤. ë°ì´í„° ë§ˆë‹¤ ë‹¤ë¥´ì§€ë§Œ í˜„ì¬ ì—°ê¸° ë°ì´í„°ëŠ” 737ì¥ ë¿ì´ë‹¤
'''

# yolov5 ê¹ƒí—ˆë¸Œ : https://github.com/ultralytics/yolov5


%cd /content
!git clone https://github.com/ultralytics/yolov5
%cd yolov5
!pip install -qr requirements.txt

import torch
from IPython.display import Image, clear_output

#----------------------------------------------------------------------------------------------------------- í´ë¡  ìƒíƒœ ë° ëª¨ë¸ í™•ì¸
!ls data/images # bus.jpg  zidane.jpg
!python detect.py --weights yolov5s.pt --img 640 --conf 0.25 --source data/images/
Image(filename='runs/detect/exp/bus.jpg', width = 600)
Image(filename='runs/detect/exp/zidane.jpg', width = 600)

# ì—°ê¸° ë°ì´í„°ì…‹ ë‹¤ìš´ë¡œë“œ : https://public.roboflow.com/object-detection/wildfire-smoke/
# -----------------------------------------------------------------------------------------------------------í´ë”ë§
%mkdir /content/yolov5/smoke
%cd /content/yolov5/smoke

!curl -L "https://public.roboflow.com/ds/DbR39Bi81I?key=A51iFKK2Ms" > roboflow.zip; unzip roboflow.zip; rm roboflow.zip

#----------------------------------------------------------------------------------------------------------- train - test - valid
from glob import glob

train_img_list = glob('/content/yolov5/smoke/train/images/*.jpg')
test_img_list = glob('/content/yolov5/smoke/test/images/*.jpg')
valid_img_list = glob('/content/yolov5/smoke/valid/images/*.jpg')
#------------------------------------------------------------------------------------------------------------ ë°ì´í„° í™•ì¸
print(len(train_img_list), len(test_img_list), len(valid_img_list))

#------------------------------------------------------------------------------------------------------------ ë°ì´í„° ì§ë ¬í™”
import yaml

with open('/content/yolov5/smoke/train.txt', 'w') as f:
  f.write('\n'.join(train_img_list) + '\n')

with open('/content/yolov5/smoke/test.txt', 'w') as f:
  f.write('\n'.join(test_img_list) + '\n')

with open('/content/yolov5/smoke/valid.txt', 'w') as f:
  f.write('\n'.join(valid_img_list) + '\n')
  
# -----------------------------------------------------------------------------------------------------------í…œí”Œë¦¿ í™•ì¸
%cat /content/yolov5/smoke/data.yaml
'''
train: ../train/images
val: ../valid/images

nc: 1
names: ['smoke']
'''

#---------------------------------------------------------------------------------------------------------- í…œí”Œë¦¿ ìƒˆë¡œ ì“°ê¸°
# train-test-val ë¡œ ë‚˜ëˆ„ì—ˆìœ¼ë¯€ë¡œ test ì¶”ê°€
%%writetemplate /content/yolov5/smoke/data.yaml

train : /smoke/train/images
test : /smoke/test/images 
val : /smoke/valid/images

nc: 1
names: ['smoke']

# ------------------------------------------------------------------------------------------------------------- ì ìš© í™•ì¸
%cat /content/yolov5/smoke/data.yaml

# ------------------------------------------------------------------------------------------------------------ëª¨ë¸ êµ¬ì„±
with open('/content/yolov5/smoke/data.yaml', 'r') as stream:
  num_classes = str(yaml.safe_load(stream)['nc'])

%cat /content/yolov5/models/yolov5s.yaml
'''
# YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license

# Parameters
nc: 80  # number of classes
depth_multiple: 0.33  # model depth multiple
width_multiple: 0.50  # layer channel multiple
anchors:
  - [10,13, 16,30, 33,23]  # P3/8
  - [30,61, 62,45, 59,119]  # P4/16
  - [116,90, 156,198, 373,326]  # P5/32

# YOLOv5 v6.0 backbone
backbone:
  # [from, number, module, args]
  [[-1, 1, Conv, [64, 6, 2, 2]],  # 0-P1/2
   [-1, 1, Conv, [128, 3, 2]],  # 1-P2/4
   [-1, 3, C3, [128]],
   [-1, 1, Conv, [256, 3, 2]],  # 3-P3/8
   [-1, 6, C3, [256]],
   [-1, 1, Conv, [512, 3, 2]],  # 5-P4/16
   [-1, 9, C3, [512]],
   [-1, 1, Conv, [1024, 3, 2]],  # 7-P5/32
   [-1, 3, C3, [1024]],
   [-1, 1, SPPF, [1024, 5]],  # 9
  ]

# YOLOv5 v6.0 head
head:
  [[-1, 1, Conv, [512, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 6], 1, Concat, [1]],  # cat backbone P4
   [-1, 3, C3, [512, False]],  # 13

   [-1, 1, Conv, [256, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 4], 1, Concat, [1]],  # cat backbone P3
   [-1, 3, C3, [256, False]],  # 17 (P3/8-small)

   [-1, 1, Conv, [256, 3, 2]],
   [[-1, 14], 1, Concat, [1]],  # cat head P4
   [-1, 3, C3, [512, False]],  # 20 (P4/16-medium)

   [-1, 1, Conv, [512, 3, 2]],
   [[-1, 10], 1, Concat, [1]],  # cat head P5
   [-1, 3, C3, [1024, False]],  # 23 (P5/32-large)

   [[17, 20, 23], 1, Detect, [nc, anchors]],  # Detect(P3, P4, P5)
  ]
'''

#---------------------------------------------------------------------------------------- ox ë¥¼ ê³¨ë¼ë‚´ëŠ” ì‘ì—…ì´ë¯€ë¡œ ncë¥¼ ë°”ê¿”ì„œ ì¬ì‘ì„±
%%writetemplate /content/yolov5/models/custom_yolov5s.yaml

# YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license

# Parameters
nc: {num_classes}  # number of classes
depth_multiple: 0.33  # model depth multiple
width_multiple: 0.50  # layer channel multiple
anchors:
  - [10,13, 16,30, 33,23]  # P3/8
  - [30,61, 62,45, 59,119]  # P4/16
  - [116,90, 156,198, 373,326]  # P5/32

# YOLOv5 v6.0 backbone
backbone:
  # [from, number, module, args]
  [[-1, 1, Conv, [64, 6, 2, 2]],  # 0-P1/2
   [-1, 1, Conv, [128, 3, 2]],  # 1-P2/4
   [-1, 3, C3, [128]],
   [-1, 1, Conv, [256, 3, 2]],  # 3-P3/8
   [-1, 6, C3, [256]],
   [-1, 1, Conv, [512, 3, 2]],  # 5-P4/16
   [-1, 9, C3, [512]],
   [-1, 1, Conv, [1024, 3, 2]],  # 7-P5/32
   [-1, 3, C3, [1024]],
   [-1, 1, SPPF, [1024, 5]],  # 9
  ]

# YOLOv5 v6.0 head
head:
  [[-1, 1, Conv, [512, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 6], 1, Concat, [1]],  # cat backbone P4
   [-1, 3, C3, [512, False]],  # 13

   [-1, 1, Conv, [256, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 4], 1, Concat, [1]],  # cat backbone P3
   [-1, 3, C3, [256, False]],  # 17 (P3/8-small)

   [-1, 1, Conv, [256, 3, 2]],
   [[-1, 14], 1, Concat, [1]],  # cat head P4
   [-1, 3, C3, [512, False]],  # 20 (P4/16-medium)

   [-1, 1, Conv, [512, 3, 2]],
   [[-1, 10], 1, Concat, [1]],  # cat head P5
   [-1, 3, C3, [1024, False]],  # 23 (P5/32-large)

   [[17, 20, 23], 1, Detect, [nc, anchors]],  # Detect(P3, P4, P5)
  ]
  
#--------------------------------------------------------------------------------------------------------- ì ìš© ìƒíƒœ í™•ì¸
%cat /content/yolov5/models/custom_yolov5s.yaml

#--------------------------------------------------------------------------------------------------------- í•™ìŠµ
'''
- img: ì…ë ¥ ì´ë¯¸ì§€ í¬ê¸° ì •ì˜
- batch: ë°°ì¹˜ í¬ê¸° ê²°ì •
- epochs: í•™ìŠµ ê¸°ê°„ ê°œìˆ˜ ì •ì˜
- data: yaml íŒŒì¼ ê²½ë¡œ
- cfg: ëª¨ë¸ êµ¬ì„± ì§€ì •
- weights: ê°€ì¤‘ì¹˜ì— ëŒ€í•œ ê²½ë¡œ ì§€ì •
- name: ê²°ê³¼ ì´ë¦„
- nosave: ìµœì¢… ì²´í¬í¬ì¸íŠ¸ë§Œ ì €ì¥
- cache: ë¹ ë¥¸ í•™ìŠµì„ ìœ„í•œ ì´ë¯¸ì§€ ìºì‹œ
'''
%%time
%cd /content/yolov5
!python train.py --img 640 --batch 32 --epochs 100 --data ./pothole/data.yaml --cfg ./models/custom_yolov5s.yaml --weights '' --name smoke_results --cache

#------------------------------------------------------------------------------------------------------------ tensor board ì‹œê°í™”
%load_ext tensorboard
%tensorboard --logdir runs

#------------------------------------------------------------------------------------------------------------ í•™ìŠµ íŒŒì¼ ìƒì„± í™•ì¸
!ls runs/train/smoke_results52

#---------------------------------------------------------------------------------------------------------------- ê²°ê³¼ í™•ì¸
Image(filename = 'runs/train/smoke_results/results.png', width = 1000)
Image(filename = 'runs/train/smoke_results/train_batch0.jpg', width = 1000)
Image(filename = 'runs/train/smoke_results52/val_batch0_labels.jpg', width = 1000)

#------------------------------------------------------------------------------------------------------------------ ê²€ì¦
!python detect.py --weights runs/train/smoke_results/weights/best.pt --img 640 --conf 0.4 --source ./smoke/test/images
!python val.py --weights runs/train/pothole_results/weights/best.pt --data ./smoke/data.yaml --img 640 --task test

#------------------------------------------------------------------------------------------------------------------- ì¶”ë¡ 
# ëª¨ë¸ ìƒì„± ìƒíƒœ í™•ì¸
%ls runs/train/smoke_results/weights
!python detect.py --weights runs/train/smoke_results/weights/best.pt --img 640 --conf 0.4 --source ./smoke/test/images

# randomì„ í†µí•´ ì‹¤í–‰í•  ë•Œ ë§ˆë‹¤ ë‹¤ë¥¸ ì‚¬ì§„ì˜ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤Œ
import glob
import random
from IPython.display import Image, display

# ì•Œë§ì€ ê²½ë¡œ ì˜ ì°¾ê¸°
image_name = random.choice(glob.glob('/content/yolov5/runs/detect/exp2/*.jpg'))
display(Image(filename=image_name))

#------------------------------------------------------------------------------------------------------------------ ëª¨ë¸ ì €ì¥
# google drive mount
from google.colab import drive
drive.mount('/content/drive')

# í´ë”ë§ ë° ëª¨ë¸ ì €ì¥
%mkdir /content/drive/My\ Drive/pothole
%cp /content/yolov5/runs/train/pothole_results/weights/best.pt /content/drive/My\ Drive/pothole
